:docinfo:

= SAP Data Intelligence 3 on CaaS Platform 4.2

== Introduction

This guide describes the installation of SAP Data Intelligence 3 on premise on top of SUSE CaaS Platform 4.

== Pre-requisites

=== Hardware

* Sizing

For sizing information see the SAP documentation that can be found here:
// FIXME add link to SAP sizing guide for DI

* Minimal requirements

At least 8 nodes are needed for a production grade Kubernetes cluster:

* 3 master nodes

* 4 worker nodes

* 1 or 2 Loadbalancer(s) ; those can be virtual machines.

For the installation of CaaSP 4.2 additional hosts are needed

* Management host ; this host can be a virtual machine.

* registry for storing container images ; this can be a virtual machine.


=== Software

* SLE 15 SP1

* SUSE CaaSP 4.2



== Installation of SUSE CaaSP 4.2

=== Documentation

* https://documentation.suse.com/

// CAVE!
// This has to be removed when the fix is shipped as maintenance update.
Due to a bug in cri-o version shipped with SUSE CaaSP 4.2 at the time of this writing, it is necessary to ask SUSE for a PTF for SUSE bug bsc# 117400.
Download the PTF and install it on all your CaaSP cluster nodes.

// Link to the SUSE TID How to install a PTF.

=== Preparations

Install on all nodes SLE 15 SP1 or higher (as released for CaaS Platform 4.x).
The following Modules/Products are required on the respective hosts:

* Management host

** SLE 15 SP1
** SLE 15 SP1 Containers Modules
** SLE 15 SP1 Public Cloud
** SUSE CaaSP 4


* Kubernetes master nodes

** SLE 15 SP1
** SLE 15 SP1 Public Cloud
** SUSE CaaSP 4

* Kubernetes worker nodes

** SLE 15 SP1
** SLE 15 SP1 Public Cloud
** SUSE CaaSP 4

* Loadbalancer host

** SLES 15 SP1 for SAP applications

or

** SLE 15 SP1 plus High Availability Extension

=== Base installation of the CaaSP 4 cluster nodes

* Install SLE 15 SP1

** Do not configure swap space for the Kubernetes nodes!

=== Installing the loadbalancer for the Kubernetes cluster

* Install SLE 15 SP1
* Install ha-proxy or nginx
* Configure the loadbalancer

=== Installation of the Management workstation

* Install SLE 15 SP1

* Add necessary SLE 15 SP1 modules

=== Bootstrap the SUSE CaaSP 4 Cluster

Run skuba tool for initialisation of the cluster.
Make sure that ssh is working between all nodes without using passwords and configure ssh-agent.

----
$ skuba init --target <FQDN / IP of loadbalancer>
----

Add additional master nodes

----
$ cd my-cluster
$ skuba --role master --target
----

Add worker nodes
----
$ cd my-cluster
$ skuba
----
Repeat for all worker nodes.

Finally check cluster status.
----
$ cd my-cluster
$ skuba cluster status
$ kubectl get nodes -o wide
----

== Secure private registry for container images (optional if you aleady own a private secure registry)

== SUSE Enterprise Storage (optional if you have a storage that provides rbd volumes and/or s3 buckets)


== Installation of SAP Data Intelligence 3 on top of SUSE CaaSP 4.2

=== Documentation

// FIXME add links

* SAP Notes:

** Release Notes for SAP Data Intelligence 3

** Installation Notes

* Installation Guide for SAP Data Intelligence


=== Planning the Installation with the SAP Maintenance Planner

For the installation of SAP Data Intelligence you have to start with the SAP Maintenance Planner that can be reached by this URL:
You also need your SAP S-User at hand.

link:https://support.sap.com/en/alm/solution-manager/processes-72/maintenance-planner.html[SAP Maintenance Planner]

image::SAP-DI-30-CaaSP42-0001.png[title="SAP Maintenance Planner Start page",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0002.png[title="SAP Maintenance Planner: Select Plan",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0003.png[title="SAP Maintenance Planner: Select Container Based Product",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0004.png[title="SAP Maintenance Planner: Select Container Based Product #2",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0005.png[title="SAP Maintenance Planner: Select Data Intelligence 3",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0006.png[title="SAP Maintenance Planner: Select Continue",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0007.png[title="SAP Maintenance Planner: Choose from available patch levels as you need. ",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0008.png[title="SAP Maintenance Planner: Choose according your needs and confirm.",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0009.png[title="SAP Maintenance Planner: Choose next if satisfied",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0010.png[title="SAP Maintenance Planner: Choose Linux and confirm",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0011.png[title="SAP Maintenance Planner: Confirm",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0012.png[title="SAP Maintenance Planner: Execute Plan",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0013.png[title="SAP Maintenance Planner: Download Stack.xml and SLC Bridge Installer",480,640,scaledwidth=80%,align=center]

Download the SLC Bridge Installer and copy it to your management workstation. You will need it in the next Chapter: Installing the SAP SLC Bridge.

image::SAP-DI-30-CaaSP42-0014.png[title="SAP Maintenance Planner: Enter FQDN of host where the SLC Bridge will run",480,640,scaledwidth=80%,align=center]

image::SAP-DI-30-CaaSP42-0015.png[title="SAP Maintenance Planner: Example for host and port",480,640,scaledwidth=80%,align=center]



=== Installing the SAP SLC Bridge

* Download the file containing the SLC Bridge Installer

* copy this file to the management workstation, if not already done.

* run the installer of the SLC bridge on the management workstation.

// Prepare environment for kubectl, helm etc.

----
$ ./SLCB01_50-70003322.EXE init --SAP_REPO_STAGE val
----

Identify the service port for the slc bridge:
----
$ kubectl -n sap-slcbridge get svc
----
Example output:
----
 kubectl -n sap-slcbridge get svc
 output here.
----

//add images


=== Installation of SAP Data Intelligence 3

This section describes the installation of SAP Data Intelligence 3 on top of SUSE CaaSP 4.2

==== Preparations

Before the installation of SAP DI 3 can start, some preparation work has to be done.

* Create a namespace on Kubernetes cluster

* Define a (default) storage class on the Kubernetes cluster

* Adapt PodSecurityPolicies

* create ClusterRoleBindings

* in case of using self signed certifcates, a special secret has to be created

===== Create namespace for SAP DI 3 on Kubernetes

Define the namespace where Data Intelligence will be installed to:

----
$ kubectl create namespace di303
----



===== Create Storage Class

* Create storage class

Create the storage class to provide volumes for SAP Data Intelligence 3 on SUSE Enterprise Storage:

Make sure you have the connection data for your SUSE Enterprise Storage at hand.

* IP addresses and port number (defaults to 6789) of the monitor nodes of your SUSE Storage

* created a data pool (datahub in this example) on your SUSE Enterprise Storage for the use with SAP Data Intelligence 3

Edit the example below to fit your environment.

----
$ cat > storageClass.yaml <<EOF
apiVersion: storage.kubernetes.io/v1
kind: StorageClass
metadata:
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
  name: datahub
  namespace: default
parameters:
  adminId: admin
  adminSecretName: ceph-admin-secret
  adminSecretNamespace:  default
  imageFeatures: layering
  imageFormat: "2"
  monitors: <IP ADDRESS OF MONITOR 1>:6789, <IP ADDRESS OF MONITOR 2>:6789, <IP ADDRESS OF MONITOR 3 >:6789
  pool: datahub
  userId: admin
  userSecretName: ceph-user-secret
provisioner: kubernetes.io/rbd
reclaimPolicy: Delete
volumeBindingMode: Immediate
EOF

$ kubectl create -f storageClass.yaml
----

* Create secrets for the StorageClass
Create the secrets needed to access the storage:
Obtain the keys from your SUSE Storage located in
ceph.admin.keyring and ceph.user.keyring

You have to do a base64 encoding of the keys

----
$ echo <YOUR KEY HERE> | base64
----

----
$ cat > ceph-admin-secret.yaml <<EOF
apiVersion: v1
kind: Secret
metadata:
    name: ceph-admin-secret
type: "kubernetes.io/rbd"
data:
   key: <YOUR BASE64 ENCODED KEY HERE>
EOF
image::002-SCT-CaaSP.png
$ cat > ceph-user-secret.yaml <<EOF
apiVersion: v1
kind: Secret
metadata:
    name: ceph-user-secret
type: "kubernetes.io/rbd"
data:
   key: <YOUR BASE64 ENCODED KEY HERE>
EOF

$ kubectl create -f ceph-admin-secret.yaml
$ kubectl create -f ceph-user-secret.yaml
----

----
//does this work ?
$ kubectl -n di303 create -f ceph-admin-secret.yaml
$ kubectl -n di303 create -f ceph-user-secret.yaml
----


===== Create PodSecurityPolicies and ClusterRoleBindings

* PodSecurityPolicies
----
----


* ClusterRoleBindings
----
----

* additional changes


==== Installation of SAP DI 3

===== Connect to the SLC-Bridge

* Point your browser to the SLC-Bridge service

** https://<yournode>:<yourport>/docs/index.html

* fill in your credentials


===== Installation work flow

// FIXME lots of images

/*
// FIXME Parameters used in the installation workflow
// from SAP Note:
// -e Choose "Configure container log path" for "Docker Container Log Path Configuration"
// Set "Container Log Path" as "/var/log/containers"
// Set "Enable Kaniko Usage" as yes
// "-e diagnostic.fluentd.logDriverFormat=regexp -e vsystem.vRep.exportsMask=true" into "Additional Installation Parameters"
// container log path
// enable kaniko
// load kernel module nfsd and nfsv4 !! CAVE !! 5.x kernels might crash when container tries to load these modules. This for future releases on SLE 15 SP2.
*/
/*

//    If the registry certificate is untrusted or self-signed, follow the steps below in order to create necessary Kubernetes secret with the certificates so that SAP Data Intelligence installation procedure can import it into SAP Data Intelligence Connection Manager.
//        Certificate chain should be saved into file named "cert" in PEM format.
//        export DI installation namespace into NAMESPACE environment variable.
//        Ensure that your file doesn't contain DOS-type line endings. To convert from DOS-type line endings, you may use the following commmands:
//
//                mv cert cert_with_carriage_return
//
//                tr -d '\r' < cert_with_carriage_return > cert
//
//        run "kubectl create secret generic cmcertificates --from-file=cert -n $NAMESPACE" command.

*/


== Appendix



// Standard SUSE Best Practices includes
== Legal Notice
include::common_sbp_legal_notice.adoc[]

++++
<?pdfpagebreak?>
++++

// Standard SUSE Best Practices includes
include::common_gfdl1.2_i.adoc[]
