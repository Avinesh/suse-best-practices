:docinfo:

// = {title}
= WordPress on LAMP on SUSE Linux Enterprise Server
// SUSE Linux Enterprise Server 12, SUSE Linux Enterprise Server 15
// :author: James Yang
:revnumber: 0.0.1
:toc2:
:toc-title: WordPress on LAMP on SLES
:toclevels: 4

:sles: SUSE Linux Enterprise Server

== Scope
This guide details how to install and configure https://mariadb.org/[MariaDB], https://httpd.apache.org/[Apache], https://www.php.net/[PHP] to compose the https://en.wikipedia.org/wiki/LAMP_(software_bundle)[LAMP] stack on https://www.suse.com/products/server/[{sles}]. To demonstrate our LAMP stack is functional we'll install and configure https://wordpress.com[WordPress]. The result is not intended for production scenarios but rather for *workshops* or *demos*.

=== LAMP Stack

- **L**inux - {sles} Operating System
- **A**pache - HTTP Server
- **M**ariaDB - Relational Database
- **P**HP - Programming Language

This diagram roughly visualizes what the stack looks like once completed.

image::TRD-wordpress-on-lamp-on-sles_one-tier.png[align="center"]

=== MariaDB and MySQL

Starting with {sles} 12, MySQL has been https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12/#fate-316482[replaced] with MariaDB. MariaDB's client protocol is "wire" compatible with MySQL's protocol and in most scenarios even the data files are binary compatible. For our purposes MariaDB will work just fine (and still spells LAMP!). If you'd like more information visit https://mariadb.com/kb/en/mariadb-vs-mysql-compatibility/[MariaDB versus MySQL: Compatibility].


== Preinstallation

=== System requirements

* CPU with 1 core
* AMD64/Intel 64 architecture
* 2 GB disk space
* 2 GB RAM

NOTE: These requirements cover a minimal installation, adapt as needed to cover your use case.

[id="server_registration"]
=== Server registration

Before starting, ensure your {sles} instance is registered by following this knowledge base https://www.suse.com/support/kb/doc/?id=000018564[article] to enable access to repositories.


=== Refresh repositories
. Prior to starting the installation, let's refresh our repositories and ensure we have the latest packages

+
[source,bash]
----
> sudo zypper update --no-confirm

Refreshing service 'Basesystem_Module_15_SP3_x86_64'.
Refreshing service 'SUSE_Linux_Enterprise_Server_15_SP3_x86_64'.
Refreshing service 'Server_Applications_Module_15_SP3_x86_64'.
Loading repository data...
Reading installed packages...
Resolving package dependencies...
...
----

== Install and Configure

We'll first start with getting MariaDB installed, then creating a database and associated user

=== MariaDB Setup
. Install the MariaDB package

+
[source,bash]
----
> sudo zypper in --no-confirm mariadb

Refreshing service 'Basesystem_Module_15_SP3_x86_64'.
Refreshing service 'SUSE_Linux_Enterprise_Server_15_SP3_x86_64'.
Refreshing service 'Server_Applications_Module_15_SP3_x86_64'.
Loading repository data...
Reading installed packages...
Resolving package dependencies...

The following 9 NEW packages are going to be installed:
  libJudy1 libmariadb3 libpq5 mariadb mariadb-client mariadb-errormessages psqlODBC python3-mysqlclient unixODBC

The following 2 recommended packages were automatically selected:
  mariadb psqlODBC

9 new packages to install.
Overall download size: 23.7 MiB. Already cached: 0 B. After the operation, additional 171.2 MiB will be used.
Continue? [y/n/v/...? shows all options] (y): y
Retrieving package libmariadb3-3.1.13-3.30.1.x86_64                                                                                             (1/9), 132.3 KiB (354.9 KiB unpacked)
...
----

. Enable MariaDB to start on boot (optional)
+
[source,bash]
----
> sudo systemctl enable mariadb

Created symlink /etc/systemd/system/mysql.service → /usr/lib/systemd/system/mariadb.service.
Created symlink /etc/systemd/system/multi-user.target.wants/mariadb.service → /usr/lib/systemd/system/mariadb.service.
----

. Start MariaDB
+
[source,bash]
----
> sudo systemctl start mariadb
----

. Ensure MariaDB is started -> active(running)
+
[source,bash]
----
> sudo systemctl status mariadb

● mariadb.service - MariaDB database server
   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; disabled; vendor preset: disabled)
   Active: active (running) since Fri 2021-07-02 01:55:22 UTC; 7s ago
     Docs: man:mysqld(8)
           https://mariadb.com/kb/en/library/systemd/
  Process: 26513 ExecStartPre=/usr/lib/mysql/mysql-systemd-helper upgrade (code=exited, status=0/SUCCESS)
  Process: 26447 ExecStartPre=/usr/lib/mysql/mysql-systemd-helper install (code=exited, status=0/SUCCESS)
 Main PID: 26519 (mysqld)
   Status: "Taking your SQL requests now..."
    Tasks: 30
   CGroup: /system.slice/mariadb.service
           └─26519 /usr/sbin/mysqld --defaults-file=/etc/my.cnf --user=mysql
----

. Verify we can connect to MariaDB with the client
+
[source,bash]
----
> mariadb -u root

Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 3
Server version: 10.5.11-MariaDB MariaDB package

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> 

----

. The MariaDB installation comes with a pesky default user that can mask login attempts from other users from localhost. While still in the MariaDB shell, let's remove this user.
+
[source,sql]
----
MariaDB [(none)]> DROP USER ''@localhost;
Query OK, 0 rows affected (0.003 sec)
----

. Now let's create a database for wordpress and a corresponding user. Replace `password` with your own password. Exit the shell once completed.
+
[source,sql]
----
MariaDB [(none)]> CREATE DATABASE IF NOT EXISTS wordpress;
Query OK, 1 row affected (0.000 sec)

MariaDB [(none)]> GRANT ALL PRIVILEGES ON wordpress.* TO 'wordpress' IDENTIFIED BY 'password';
Query OK, 0 rows affected (0.003 sec)

MariaDB [(none)]> exit
Bye
----

. Verify we can connect as the wordpress user. Replace `password` with your own password.
+
[source,sql]
----
mariadb -u wordpress -p wordpress
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 4
Server version: 10.5.11-MariaDB MariaDB package

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [wordpress]> exit
Bye

----


=== Apache Http Server Setup

Next up is Apache server.

. Install the apache2 package
+
[source,bash]
----
> zypper install --no-confirm apache2

zypper install --no-confirm apache2
Refreshing service 'Basesystem_Module_15_SP3_x86_64'.
Refreshing service 'SUSE_Linux_Enterprise_Server_15_SP3_x86_64'.
Refreshing service 'Server_Applications_Module_15_SP3_x86_64'.
Refreshing service 'Web_and_Scripting_Module_15_SP3_x86_64'.
Loading repository data...
Reading installed packages...
Resolving package dependencies...

The following 2 NEW packages are going to be installed:
  apache2 apache2-prefork

2 new packages to install.
Overall download size: 1.6 MiB. Already cached: 0 B. After the operation, additional 4.9 MiB will be used.
Continue? [y/n/v/...? shows all options] (y): y
Retrieving package apache2-2.4.43-3.22.1.
...

----

. Enable the apache2 service so it starts on boot (optional)
+
[source,bash]
----
> systemctl enable apache2

Created symlink /etc/systemd/system/httpd.service → /usr/lib/systemd/system/apache2.service.
Created symlink /etc/systemd/system/apache.service → /usr/lib/systemd/system/apache2.service.
Created symlink /etc/systemd/system/multi-user.target.wants/apache2.service → /usr/lib/systemd/system/apache2.service.

----

=== PHP Setup

With Apache installed, let's continue with php.

. We'll need the _Web and Scripting Module_ which is included with your {sles} subscription. Substitute with your specific version and architecture.

+
[source,bash]
----
> sudo SUSEConnect --product sle-module-web-scripting/{sles_version}/{architecture}

e.g.

> sudo SUSEConnect --product sle-module-web-scripting/15.3/x86_64

Registering system to SUSE Customer Center

Updating system details on https://scc.suse.com ...

Activating sle-module-web-scripting 15.3 x86_64 ...
-> Adding service to system ...
-> Installing release package ...

Successfully registered system
----

. Now we can install php and the Apache php module we'll need later on.

+
[source,bash]
----
> sudo zypper in -y php php-mysql php-zlib apache2-mod_php7

Refreshing service 'Basesystem_Module_15_SP3_x86_64'.
Refreshing service 'SUSE_Linux_Enterprise_Server_15_SP3_x86_64'.
Refreshing service 'Server_Applications_Module_15_SP3_x86_64'.
Refreshing service 'Web_and_Scripting_Module_15_SP3_x86_64'.
Loading repository data...
Reading installed packages...
Resolving package dependencies...

The following 13 NEW packages are going to be installed:
  apache2-mod_php7 php7 php7-ctype php7-dom php7-iconv php7-json php7-mysql php7-pdo php7-sqlite php7-tokenizer php7-xmlreader php7-xmlwriter php7-zlib

The following 8 recommended packages were automatically selected:
  php7-ctype php7-dom php7-iconv php7-json php7-sqlite php7-tokenizer php7-xmlreader php7-xmlwriter

The following 3 packages are suggested, but will not be installed:
  php7-gd php7-gettext php7-mbstring

13 new packages to install.
Overall download size: 3.7 MiB. Already cached: 0 B. After the operation, additional 20.5 MiB will be used.
Continue? [y/n/v/...? shows all options] (y): y
...

----

. Test our php install

+
[source,bash]
----
> php --version

PHP 7.4.6 (cli) ( NTS )
Copyright (c) The PHP Group
Zend Engine v3.4.0, Copyright (c) Zend Technologies
----

. Enable the apache php module
+
[source,bash]
----
> a2enmod php7
----

. Associate php files with the `application/x-httpd-php` content type so php files are rendered on the client.
+
[source,bash]
----
> echo -e "AddType application/x-httpd-php .php\n" >> /etc/apache2/mod_mime-defaults.conf
----


=== WordPress Setup

Final component in our stack is WordPress.

. First download wordpress 

+
[source,bash]
----
> curl -L https://wordpress.org/latest.zip -o /opt/wordpress_latest.zip

  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 15.7M  100 15.7M    0     0  3209k      0  0:00:05  0:00:05 --:--:-- 3510k
----

. Extract the zip file
+
[source,bash]
----
> unzip /opt/wordpress_latest.zip -d /opt

 unzip /opt/wordpress_latest.zip -d /opt/wordpress
Archive:  /opt/wordpress_latest.zip
   creating: /opt/wordpress/wordpress/
  inflating: /opt/wordpress/wordpress/xmlrpc.php  
  inflating: /opt/wordpress/wordpress/wp-blog-header.php  
  inflating: /opt/wordpress/wordpress/readme.html  

...

----

. By default Apache serves documents from `/srv/www/htdocs`, so let's move the WordPress contents there
+
[source,bash]
----
> mv wordpress/* /srv/www/htdocs/
----

. Create a copy of the `wp-config` php configuration file so we can apply our installation specific settings.
+
[source,bash]
----
> cp /srv/www/htdocs/wp-config-sample.php /src/www/htdocs/wp-config.php
----

. Now update the configuration with the database setttings. Replace `password` with your password.
+
[source,bash]
----
> sed -i 's/database_name_here/wordpress/' /srv/www/htdocs/wp-config.php
> sed -i 's/username_here/wordpress/' /srv/www/htdocs/wp-config.php
> sed -i 's/password_here/password/' /srv/www/htdocs/wp-config.php
----

=== Configure Firewalld

. You may need to open up port 80 on the firewall to allow clients to connect to Apache. If you're not using a firewall or it's disabled, skip this step.
+
[source,bash]
----
> firewall-cmd --permanent --add-service http

You''re performing an operation over default zone ('external'),
but your connections/interfaces are in zone 'docker' (see --get-active-zones)
You most likely need to use --zone=docker option.

success
----

. Reload the firewall to apply the changes
+
[source,bash]
----
> firewall-cmd --reload

success
----

=== Start it Up

. Everything should be configured now, so we can start up Apache server
+
[source,bash]
----
> systemctl start apache2
----

. Open a browser with your server ip or hostname at http://`hostname` and you should be presented with the WordPress installation page. Congrats!

image::TRD-wordpress-on-lamp-on-sles_wordpress-installation-page.png[align="center"]

== 2-Tier Architecture

If you'd like create a 2 tier architecture and separate the database server from the application server like so:

image::TRD-wordpress-on-lamp-on-sles_two-tier.png[align="center"]

Just a few additional steps are needed. As before, ensure both servers are <<server_registration,registered>> before starting.

=== Database server

First, repeat the previous steps for <<MariaDB Setup>> on the database server. On the same server make the following changes:

. MariaDB binds only to the loopback interface by default, so let's change it to bind to all addreses.
+
[source,bash]
----
> sed -i 's/= 127.0.0.1/= 0.0.0.0/' /etc/my.cnf
----

. Restart MariaDB so it picks up the changes
+
[source,bash]
----
> systemctl restart mariadb
----

. Open up port 3306 (default for MariaDB) so clients can connect (Skip this step if not using firewall)
+
[source,bash]
----
> firewall-cmd --add-port 3306/tcp --permanent

success
----

=== Application Server

On the application server:

. Verify the Application Server can connect to the Database Server
+
[source,bash]
----
> nc -vz ${ip of database server} 3306

e.g. 
>  nc -vz 10.0.0.40 3306
Connection to 10.0.0.40 3306 port [tcp/mysql] succeeded!
----

Then repeat the previous steps for the <<Apache Http Server Setup>>, <<PHP Setup>>, <<WordPress Setup>> as well as the <<Configure Firewalld>> portion.

. One additional step is required to point WordPress at the database server. Replace `application_server_ip` with the ip address of your MariaDB server
+
[source,bash]
----
> sed -i "s/'DB_HOST', 'localhost'/'DB_HOST', '${application_server_ip}'/" /srv/www/htdocs/wp-config.php

e.g.
> sed -i "s/'DB_HOST', 'localhost'/'DB_HOST', '10.0.0.40'/" /srv/www/htdocs/wp-config.php
----

. Visit http://`application_server_ip` with a browser and you should be good to go!


== Appendix

[id="debugging"]
=== Debugging WordPress
. If you need to the debug why the WordPress page won't load or encounter an error, it can insightful to enable WordPress debugging.

+
--
[source,bash]
----
> sed -i "s/'WP_DEBUG', false/'WP_DEBUG', true/" /srv/www/htdocs/wp-config.php
----

Then reload the page. This will enable printing of php errors and warnings on the page. In this example, we used the wrong password and MariaDB returned an error to the php client.

image::TRD-wordpress-on-lamp-on-sles_debugging.png[align="center"]

For more details on further WordPress debugging see https://wordpress.org/support/article/debugging-in-wordpress/[WordPress debugging].
--

. To revert, just simply set to false again.
+
[source,bash]
----
> sed -i "s/'WP_DEBUG', true/'WP_DEBUG', false/" /srv/www/htdocs/wp-config.php
----


=== References

* https://en.wikipedia.org/wiki/LAMP_%28software_bundle%29[LAMP (software bundle)]
* https://www.ibm.com/cloud/learn/lamp-stack-explained[LAMP Stack explained]
* https://www.webopedia.com/definitions/lamp/[webopedia LAMP]
* https://wordpress.org/support/article/how-to-install-wordpress[How to install wordpress]
* https://wordpress.org/support/article/debugging-in-wordpress/[WordPress debugging]
* http://httpd.apache.org/docs/current/install.html[Compiling and Installing Apache]
* https://mariadb.com/kb/en/installing-mariadb-with-zypper/[Installing MariaDB with zypper]
* https://www.suse.com/releasenotes/x86_64/SUSE-SLES/12/#fate-316482[SLES 12 Release Notes]
* https://mariadb.com/kb/en/mariadb-vs-mysql-compatibility/[MariaDB vs MySQL Compatibility]
* https://documentation.suse.com/sles/15-SP1/html/SLES-all/cha-security-firewall.html[SLES 15 - Masquerading and Firewalls]

:leveloffset: 0
// Standard SUSE Best Practices includes
== Legal notice
include::common_sbp_legal_notice.adoc[]

++++
<?pdfpagebreak?>
++++

// Standard SUSE Best Practices includes
// include::common_gfdl1.2_i.adoc[]

:leveloffset: 0
include::common_gfdl1.2_i.adoc[]
