<?xml version="1.0" encoding="UTF-8"?>
<!--<?oxygen RNGSchema="http://www.oasis-open.org/docbook/xml/5.0/rng/docbook.rng" type="xml"?>-->
<!DOCTYPE article [
<!ENTITY % entity SYSTEM "entity-decl.ent">
%entity;
]>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="art.sbp.geo.drbd" xml:lang="en">
    <info>
        <title>Migrating from KVM for IBM z Systems to KVM integrated with SUSE Linux Enterprise
            Server</title>
        <subtitle/>
        <orgname>SUSE Best Practices</orgname>
        <productname>SUSE Linux Enterprise Server for IBM z Systems and LinuxOne</productname>
        <productnumber>12 SP2</productnumber>
        <!-- <productname>KVM for IBM z Systems</productname>-->
        <!-- <productnumber>12 SP2</productnumber>-->
        <author>
            <!--  <personname>
                <firstname>Mike</firstname>
                <surname>Friesenegger, Technology Strategist - Alliances and Integrated Systems,
                    SUSE</surname>
            </personname>-->
            <personname>
                <firstname>Mike</firstname>
                <surname>Friesenegger</surname>
            </personname>
            <affiliation>
                <jobtitle>Technology Strategist - Alliances and Integrated Systems</jobtitle>
                <orgname>SUSE</orgname>
            </affiliation>
        </author>

        <date><?dbtimestamp format="B d, Y" ?></date>

        <abstract>
            <para>On March 7, 2017, IBM announced the end of support for KVM for IBM z Systems. To
                learn more, read the official IBM Withdrawal Announcement at <link
                    xlink:href="https://www-01.ibm.com/common/ssi/rep_ca/8/897/ENUS917-048/ENUS917-048.PDF"
                />. Preceding the IBM announcement on March 1, 2017, SUSE announced full support for
                KVM in SUSE Linux Enterprise Server for z Systems and LinuxONE 12 SP2 and newer
                versions. You can find more details in the article at <link
                    xlink:href="https://www.suse.com/communities/blog/virtualization-suse-kvm-support-ibm-z-systems-linuxone/"
                />.</para>

            <para>Customers that are using or testing KVM for IBM z Systems may have been using the
                IBM Redbook <quote>Getting Started with KVM for IBM z Systems</quote> at <link
                    xlink:href=" http://www.redbooks.ibm.com/abstracts/sg248332.html?Open&amp;pdfbookmark"
                /> . This SUSE Best Practices document will cover the most important details about
                how to migrate a virtual machine from KVM for IBM z Systems to KVM in SUSE Linux
                Enterprise Server.</para>
        </abstract>
    </info>


    <sect1 xml:id="sec.installing">
        <title>Installing SUSE Linux Enterprise for z Systems and LinuxONE as KVM Host</title>

        <para>Like KVM for IBM z Systems, KVM in SUSE Linux Enterprise Server is supported when
            installed into an PR/SM LPAR. The section <quote>Installation on IBM z Systems</quote>
            of the SUSE Linux Enterprise Server Deployment Guide at <link
                xlink:href="https://www.suse.com/documentation/sles-12/book_sle_deployment/data/cha_zseries.html"
            /> provides information regarding supported hardware and memory requirements for
            installing into an LPAR. The section <quote>Overiew of an LPAR Installation</quote> at
                <link
                xlink:href="https://www.suse.com/documentation/sles-12/book_sle_deployment/data/sec_zseries_prep.html#sec_prep_inst_types"
            /> reviews the preparation and initial steps in starting the SUSE Linux Enterprise
            Server Installation System. </para>

        <para>A suggested partitioning layout includes separating the storage of the KVM disk images
            from the operating system. Using the BTRFS filesystem for the operating system enables
            rollback capabilities when patching the system. The default location for the KVM disk
            images is <filename>/var/lib/libvirt/images/</filename>. It is recommended to use
            Logical Volume Manager with the XFS filesystem for KVM disk images.</para>

        <para>For the <quote>Software Selection</quote> in the installer, use the list below for the
            minimum and suggested additional patterns to be installed.</para>

        <para>Minimum Patterns:</para>
        <itemizedlist>
            <listitem>
                <para>Base System</para>
            </listitem>
            <listitem>
                <para>Minimal System (Appliances)</para>
            </listitem>
            <listitem>
                <para>Help and Support Documentation</para>
            </listitem>
            <listitem>
                <para>KVM Virtualization Host and tools</para>
            </listitem>
        </itemizedlist>
        <para>Suggested additional Patterns</para>
        <itemizedlist>
            <listitem>
                <para>GNOME Desktop Environment &amp; X Window System (needed for managing
                    virtual machines using a GUI)</para>
            </listitem>
        </itemizedlist>

        <para>Make sure to register and patch the KVM host either during the initial installation or
            after the installation is complete.</para>

    </sect1>

    <sect1 xml:id="sec.managing_kvm">
        <title>Managing KVM Instances</title>

        <para>It is recommended to use utilities that manage virtual machines using the libvirt API.
            The section <quote>Managing Virtual Machines with libvirt</quote> at <link
                xlink:href="https://www.suse.com/documentation/sles-12/book_virt/data/part_virt_libvirt.html"
            /> provides information about using both command line and GUI based tools. It is
            strongly recommended to use the previous link because it contains detailed information
            about VM installation and management as well as storage and network management for VMs.
            The sections below provide additional information about accessing a particular
            tool.</para>

        <sect2 xml:id="sec.manage_commandline">
            <title>Using the Command Line to Create and Manage Instances</title>

            <para>virsh and virt-install are the command line utilities to manage virtual machines.
                These utilities are installed as part of the KVM Virtualization Host and tools
                pattern. The section <quote>Virtualization Console Tools</quote> at <link
                    xlink:href="https://www.suse.com/documentation/sles-12/book_virt/data/sec_tools_intro_console.html"
                /> provides an introdution to these utilites.</para>

            <para>Use ssh to log into the KVM host to use virsh and virt-install.</para>
        </sect2>

        <sect2 xml:id="sec.manage_gui">
            <title>Managing Virtual Machines Using a GUI</title>

            <para>Virtual Machine Manager (virt-manager) is the GUI tool used to manage virtual
                machines. This utility is installed as part of the KVM Virtualization Host and tools
                pattern. The section <quote>Virtualization GUI Tools</quote> at <link
                    xlink:href="https://www.suse.com/documentation/sles-12/book_virt/data/sec_tools_intro_gui.html"
                /> provides an introduction.</para>

            <para>To access the virt-manager GUI, use X11 forwarding via ssh or vncviewer. X11
                forwarding is a good option if the connection (local or metropolitan area network)
                speed between the client and the KVM host is fast. Use vncviewer if you find that
                X11 redirection is too slow. Perform the following actions to enable access to
                virt-manager.</para>

            <itemizedlist>
                <listitem>
                    <para>Both X11 forwarding via ssh and vncviewer</para>
                    <itemizedlist>
                        <listitem>
                            <para>Install the Suggested additional Patterns listed above using YAST
                                or zypper</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>For X11 forwarding via ssh</para>
                    <itemizedlist>
                        <listitem>
                            <para>From a client terminal, ssh -X &lt;KVM hostname&gt;</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>For vncviewer access to the KVM host</para>
                    <itemizedlist>
                        <listitem>
                            <para>Start YaST and go into Network Services | Remote Administration
                                (VNC)</para>
                        </listitem>
                        <listitem>
                            <para>Select "Allow Remote Administration Without Session Management"
                                and click OK</para>
                        </listitem>
                        <listitem>
                            <para> From a client terminal, vncviewer &lt;KVM
                                hostname::1&gt;</para>
                        </listitem>
                        <listitem>
                            <para>Log in to the KVM host in the window opened by the previous
                                command</para>
                        </listitem>
                        <listitem>
                            <para>Click the Applications | Utilites | XTerm</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>Within the X11 forwarding via ssh client terminal and XTerm window in
                        vncviewer window</para>
                    <itemizedlist>
                        <listitem>
                            <para>virt-manager</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
            </itemizedlist>
        </sect2>

        <!--  <sect2 xml:id="sec.manage_webtool">
            <title>Managing virtual machines with a web based tool</title>

            <para>Kimchi is a web based tool that can be used to manage KVM virtual machines. Kimchi
                must be installed after the KVM host installtion is complete. The installation will
                install community supported packages from <emphasis role="strong">SUSE Package
                    Hub</emphasis> at <link xlink:href="https://packagehub.suse.com/"/>. The
                following procedure can be used to install Kimchi.</para>

            <para>***THE INSTALLATION PROCEDURE FOR KIMCHI WILL BE COMING SHORTLY. PLEASE CHECK BACK
                FREQUENTLY!***</para> 

        </sect2>-->

    </sect1>

    <sect1 xml:id="sec.ibmkvm_to_sleskvm">
        <title>Moving an Existing IBM KVM Virtual Machine to KVM in SUSE Linux Enterprise
            Server</title>

        <para>This is an example of how to move an KVM for IBM z Systems virtual machine to KVM
            integrated with SUSE Linux Enterprise Server. A VM was created on KVM for IBM z Systems
            following the section 3.7 of the IBM Redbook <quote>Getting Started with KVM for IBM z
                Systems </quote> at <link
                xlink:href="http://www.redbooks.ibm.com/redbooks/pdfs/sg248332.pdf"/>. This
            procedure assumes that the KVM for IBM z Systems VM has a virtual disk file and is
            attached to a virtual network defined using libvirt. Below you find the xml definition
            of the VM and virtual network based on the example in the IBM Redbook.</para>

        <bridgehead>VM Defnition</bridgehead>

        <screen>&lt;domain type='kvm'>
  &lt;name>s12s2&lt;/name>
  &lt;uuid>97968b48-295e-465a-9265-2cc89f4fb9cd&lt;/uuid>
  &lt;description>IBM KVM to SLES KVM&lt;/description>
  &lt;memory unit='KiB'>524288&lt;/memory>
  &lt;currentMemory unit='KiB'>524288&lt;/currentMemory>
  &lt;vcpu placement='static'>1&lt;/vcpu>
  &lt;os>
    &lt;type arch='s390x' machine='s390-ccw-kvmibm-1.1.1'>hvm&lt;/type>
    &lt;boot dev='hd'/>
  &lt;/os>
  &lt;clock offset='utc'/>
  &lt;on_poweroff>destroy&lt;/on_poweroff>
  &lt;on_reboot>restart&lt;/on_reboot>
  &lt;on_crash>preserve&lt;/on_crash>
  &lt;devices>
    &lt;emulator>/usr/bin/qemu-system-s390x&lt;/emulator>
      &lt;disk type='file' device='disk'>
        &lt;driver name='qemu' type='qcow2'/>
        &lt;source file='/var/lib/libvirt/images/s12s2.img'/>
        &lt;target dev='vda' bus='virtio'/>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0002'/>
      &lt;/disk>
      &lt;interface type='bridge'>
        &lt;mac address='52:54:00:58:35:20'/>
        &lt;source bridge='virbr0'/>
        &lt;model type='virtio'/>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0000'/>
      &lt;/interface>
      &lt;console type='pty'>
        &lt;target type='sclp' port='0'/>
      &lt;/console>
      &lt;memballoon model='virtio'>
        &lt;address type='ccw' cssid='0xfe' ssid='0x0' devno='0x0001'/>
      &lt;/memballoon>
   &lt;/devices>
&lt;/domain></screen>


        <bridgehead>Virtual Network Definition</bridgehead>

        <screen>&lt;network>
  &lt;name>default&lt;/name>
  &lt;uuid>4e4ab47a-3889-4eba-81d0-dda245a44091&lt;/uuid>
  &lt;forward mode='nat'>
    &lt;nat>
      &lt;port start='1024' end='65535'/>
    &lt;/nat>
   &lt;/forward>
   &lt;bridge name='virbr0' stp='on' delay='0'/>
   &lt;mac address='52:54:00:c0:47:bc'/>
   &lt;ip address='192.168.122.1' netmask='255.255.255.0'>
     &lt;dhcp>
       &lt;range start='192.168.122.2' end='192.168.122.254'/>
     &lt;/dhcp>
   &lt;/ip>
&lt;/network>
        </screen>

        <para>The VM and network definition for a customer deployment may be considerably different
            but the basic procedure to move the VM to KVM in SUSE Linux Enterprise Server will be
            that same, as outlined below.</para>

        <procedure>
            <step>
                <para>Connect via ssh to the IBM KVM host</para>
            </step>
            <step>
                <para>Find a VM configured on the IBM KVM host that you would like to move to a SLES
                    KVM host</para>
                <substeps>
                    <step>
                        <para>virsh list --all</para>
                    </step>
                    <step>
                        <para>'virsh dumpxml &lt;vmname> > ~/&lt;vmname>.xml' where
                            &lt;vmname> is a VM to move</para>
                    </step>
                    <step>
                        <para>less ~/&lt;vmname>.xml and make note of the following
                            information</para>
                        <itemizedlist>
                            <listitem>
                                <para>Location of the VM disk file which is &lt;source file= in
                                    the above VM definition</para>
                            </listitem>
                            <listitem>
                                <para>The name of the network bridge which is &lt;source bridge=
                                    in the above VM definition</para>
                            </listitem>
                        </itemizedlist>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Determine the virtual network associated to the VM</para>
                <substeps>
                    <step>
                        <para>virsh net-list --all</para>
                    </step>
                    <step>
                        <para>virsh net-dumpxml &lt;network name> > ~/net-&lt;network
                            name>.xml</para>
                    </step>
                    <step>
                        <para>grep -H &lt;network bridge name from the information gathered
                            before> ~/net-*.xml</para>
                    </step>
                    <step>
                        <para>Make note of the filename from the grep output above</para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Copy the VM disk file, the VM xml file and the network xml file to the SLES
                    KVM host</para>
                <substeps>
                    <step>
                        <para>rsync -S --progress &lt;VM disk file> &lt;VM xml file>
                            &lt;network xml> &lt;SLES KVM
                            Host>:/var/lib/libvirt/images</para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>ssh to the SLES KVM host</para>
            </step>
            <step>
                <para>Remove bridge if already exists on KVM host</para>
                <substeps>
                    <step>
                        <para>virsh net-list --all</para>
                    </step>
                    <step>
                        <para>virsh net-undefine &lt;network name> - when the network name is
                            the same as a network name on the IBM KVM host</para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Add bridge from IBM KVM</para>
                <substeps>
                    <step>
                        <para>virsh net-define &lt;network-name></para>
                    </step>
                    <step>
                        <para>virsh net-start &lt;network-name></para>
                    </step>
                    <step>
                        <para>virsh net-autostart &lt;network-name></para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Edit VM xml file by changing</para>
                <screen>&lt;type arch='s390x' machine='s390-ccw-kvmibm-1.1.1'>hvm&lt;/type></screen>
                <para>to</para>
                <screen>&lt;type arch='s390x' machine='s390-ccw-virtio'>hvm&lt;/type></screen>
            </step>
            <step>
                <para>Define VM in SUSE Linux Enterprise Server KVM</para>
                <substeps>
                    <step>
                        <para>virsh define &lt;VM xml file></para>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Start and verify the newly migrated VM is running</para>
                <substeps>
                    <step>
                        <para>virsh start &gt;VM name></para>
                    </step>
                    <step>
                        <para>virsh list</para>
                    </step>
                    <step>
                        <para>Connect via ssh into the VM to verify that networking is
                            working</para>
                    </step>
                </substeps>
            </step>
        </procedure>


    </sect1>
    
    <sect1 xml:id="sec.legal_notice">
        <title>Legal Notice</title>
        <para>Copyright &copy;2006– 2016 SUSE LLC and contributors. All rights reserved. </para>
        <para>Permission is granted to copy, distribute and/or modify this document under the terms
            of the GNU Free Documentation License, Version 1.2 or (at your option) version 1.3; with
            the Invariant Section being this copyright notice and license. A copy of the license
            version 1.2 is included in the section entitled <quote>GNU Free Documentation
                License</quote>.</para>
        <para>SUSE, the SUSE logo and YaST are registered trademarks of SUSE LLC in the United
            States and other countries. For SUSE trademarks, see <link
                xlink:href="http://www.suse.com/company/legal/"
                >http://www.suse.com/company/legal/</link>.</para>
        <para>Linux is a registered trademark of Linus Torvalds. All other names or trademarks
            mentioned in this document may be trademarks or registered trademarks of their
            respective owners.</para>
        <para>All information found in this document has been compiled with utmost attention to
            detail. However, this does not guarantee complete accuracy. Neither SUSE LLC, its
            affiliates, the authors, nor the translators shall be held liable for possible errors or
            the consequences thereof.</para>
    </sect1>
    
    <?pdfpagebreak style="suse2013" formatter="fop"?>
    <xi:include href="license-gfdl.xml"/>
</article>
